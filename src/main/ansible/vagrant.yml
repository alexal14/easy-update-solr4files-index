#
# Copyright (C) 2017 DANS - Data Archiving and Networked Services (info@dans.knaw.nl)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

- hosts: "test"
  become: yes
  vars:
    local_test_vm_base_backend_port: 20150
  roles:
    - dans.local-test-vm-base
    - dans.local-yum-repo

########### bag store

- hosts: "test"
  vars:
    dans_config_base: "/etc/opt/dans.knaw.nl"
    stores_dir: "/data/bag-stores"
  become: yes
  tasks:

  - name: Installing bag-store package
    yum:
      name: "dans.knaw.nl-easy-bag-store"
      state: latest

  - name: Configure bag stores
    lineinfile:
        dest: "{{ dans_config_base }}/easy-bag-store/stores.properties"
        line: "{{ item.name }}={{ item.base_dir }}"
    with_items:
      - { name: "pdbs",      base_dir: "{{ stores_dir }}/pdbs" }
      - { name: "easy",      base_dir: "{{ stores_dir }}/easy" }
      - { name: "pan",       base_dir: "{{ stores_dir }}/pan" }

  - name: Create empty bag-store base directories
    file:
      path: "{{ stores_dir }}/{{ item }}"
      state: "directory"
      owner: "easy-bag-store"
      group: "easy-bag-store"
      mode: "0775"
    with_items:
    - easy
    - pan

  - name: Check whether the bags exists
    stat:
      path: "{{ stores_dir }}/pdbs"
    register: bag_dir_stat

  - name: Copy test-bags to server
    copy:
      src: "../ansible/files/pdbs"
      dest: "{{ stores_dir }}"
      mode: "0775"
      directory_mode: "0775"
    when: "bag_dir_stat.stat.exists == False"

  - service:
      name: "easy-bag-store"
      state: restarted
      enabled: yes

########### solr

- hosts: "test"
  vars:
    solr_install_dir: "/opt/org.apache"
    solr_var_dir: "/var/opt/org.apache"
    solr_home: "{{ solr_var_dir }}/solr-home"
    solr_log_dir: "{{ solr_var_dir }}/log/solr"
    solr_cores: # implicitly used by included dans.solr
      - { name: "fileitems", confdir: "sample_techproducts_configs" }
  become: yes
  tasks:

  - name: Create FHS compatible directories for Solr
    file:
      path: "{{ item }}"
      state: directory
    with_items:
      - "{{ solr_install_dir }}"
      - "{{ solr_log_dir }}"
      - "{{ solr_home }}"

  - name: Install Solr
    include_role:
      name: "dans.solr"
    vars:
      solr_install_path: "{{ solr_install_dir }}/solr"
      solr_log_file_path: "{{ solr_log_dir }}/solr.log"
      solr_version: "6.6.1"
      solr_package: "http://maven-repo.dans.knaw.nl/ext-release-local/org/apache/solr/{{ solr_version }}/solr-{{ solr_version }}.tgz"

  # TODO schema copied from https://github.com/DANS-KNAW/easy-dtap/blob/ae26915/provisioning/roles/easy_solr_search2/files/fileitems/schema.xml
  - name: Copy schemas
    copy:
      src: "../ansible/files/solr-cores/{{ item.name }}/schema.xml"
      dest: "{{ solr_var_dir }}/solr-home/data/{{ item.name }}/conf/"
    with_items: "{{ solr_cores }}"

  - service:
      name: "solr"
      state: restarted
      enabled: yes

########### the intended service

- hosts: "test"
  become: yes
  tasks:

  - name: Installing update-solr4files-index package
    yum:
      name: "dans.knaw.nl-easy-update-solr4files-index"
      state: latest

#  - service:
#      name: "easy-update-solr4files-index"
#      state: restarted
#      enabled: yes
